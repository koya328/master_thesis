\chapter{開発} 
\thispagestyle{plain}   % chapterの直後に必ず指定

本研究は，\ref{sec:minecraft}章で述べたMinecraftの特性に焦点を当て，Minecraftの中で大規模言語モデルを搭載したbotを作成し，そのbotと人間が対話を行ったり，共同作業を行ったりすることで，人間とAIの協力・協調関係の境界と可能性を探求することを目的としている．

本章では作成したbot、``Mason''について解説する．
システムの全体像は図\ref{fig:system}のとおりである．
プレイヤーはbotログイン用webアプリケーションを使用して，MasonをMinecraftのマルチサーバーに参加させることが可能である．
その後プレイヤーは，Masonが参加したマルチサーバーと同じサーバーにログインしMinecraftのチャットの機能(デフォルトでTキー)を用いてMasonと対話することが可能である．

MasonはMineflayer API\cite{bib:Mineflayer}を利用して実装されている．
Mineflayerは，botのセットアップやプレイヤーの発話や情報，ワールドの情報を読み取る機能、Minecraft内での行動を起こす機能などを総合的に提供するAPIである．
プレイヤーからの発話や情報はモードに合わせて、適切な大規模言語モデルに送り，大規模言語モデルからの返答をもとにプレイヤーへ返答や行動を行うことが可能である．

詳細な機能については\ref{sec:webapp}節から\ref{sec:build_mode}節で解説する．

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{fig/my_system.PNG}
    \caption{システムの概要}
    \label{fig:system}
\end{figure}

\section{Webアプリケーション}\label{sec:webapp}
人間とAIの協力・協調を主目的とする以上，ユーザビリティについて追求する必要があると考えたため，botをログインさせるためのWebアプリケーションを作成した．
従来までの方法でbotを動かすためには，プログラミング環境構築のスキルを必要とするが，このアプリケーションではマイクラのマルチにログインする時と同様の情報を入力することで，簡単にbotをログインさせることが可能となった．

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{fig/web_app.jpg}
    \caption{Webアプリケーションのホーム画像}
    \label{fig:web_app}
\end{figure}

\section{行動}\label{sec:act}
MasonがMinecraft世界に干渉して人間の作業などを手伝うことができるように，いくつかの行動を作成した．
Masonの各行動はMineflayer API\cite{bib:Mineflayer}を用いて実装した．
Mineflayer APIの関数は例外が発生するとbotがログアウトしてしまうため，基本的にMineflayer APIの関数に例外処理を加えて開発している．
作成した行動には表\ref{tab:action}の種類がある．

\begin{table}[H]
    \caption{行動の種類}\label{tab:action}
    \centering
    \begin{tabular}{lp{0.7\linewidth}}
        \hline \hline
        move\_to\_position & 説明: 指定した座標へ移動． \\
        　 & 引数: int x, int y, int z \\
        \hline
        mine\_block & 説明: nameで指定したブロックを指定個数採掘して集める． \\
        　 & 引数: str name, int count \\
        \hline
        smelt\_item & 説明: item\_nameで指定したアイテムをcountの個数分かまどで製錬する．fuel\_nameで燃料を指定する． \\
        　 & 引数: str item\_name, str fuel\_name, int count \\
        \hline
        mine\_block & 説明: nameで指定したブロックを指定個数採掘して集める \\
        　 & 引数: str name, int count \\
        \hline
        craft\_item & 説明: nameで指定したアイテムをcountの個数分，作業台で作成する． \\
        　 & 引数: str name, int count \\
        \hline
        get\_item\_chest & 説明: chest\_positionで指定した位置にあるチェストから，item\_dictのアイテムを個数分取り出す． \\
        　 & 引数: Vec3 chest\_position, dict[str,int] item\_dict \\
        \hline
        deposit\_item\_chest & 説明: chest\_positionで指定した位置にあるチェストに，item\_dictのアイテムを個数分入れる． \\
        　 & 引数: Vec3 chest\_position, dict[str,int] item\_dict \\
        \hline
        check\_item\_chest & 説明: chest\_positionで指定した位置にあるチェストのアイテムを確認する． \\
        　 & 引数: Vec3 chest\_position \\
        \hline
        farm & 説明: 近くの農地に所持している小麦の種を植える． \\
        　 & 引数: なし \\
        \hline
    \end{tabular}
\end{table}

\section{大規模言語モデルによるタスクの提示や会話}\label{sec:gpt_res}
複数の大規模言語モデルを組み合わせることによって，サバイバルモードのプレイヤー向けの対話機能を作成した．
この機能では，プレイヤーの発話と情報を元に，Masonが次のタスクを提示したり，\ref{sec:act}節の行動を起こすことでプレイヤーの作業を手伝ったり，質問や会話に返答することが可能になった．

プレイヤーの発話とは「how to make \textasciitilde?」，「please craft \textasciitilde.」，「please tell me next task.」のような，Masonに対する会話である．

プレイヤーの情報とは表\ref{tab:player_data}に示す，プレイヤーの現在の状態を表したJSONデータである.
\begin{table}[H]
    \caption{行動の種類}\label{tab:player_data}
    \centering
    \begin{tabular}{llp{0.6\linewidth}}
        \hline \hline
        キー & データ型 & 説明 \\
        \hline
        goals & string & プレイヤーの目標． \\
        biome & string & プレイヤーが現在居るバイオーム． \\
        time & string & Minecraft世界の現在時刻．0～23999までの値であり，13000～は夜を表す． \\
        blocks & list[string] & プレイヤーの半径10ブロック以内のブロックの種類 \\
        entities & list[string] & プレイヤーの半径10ブロック以内のエンティティの種類 \\
        health & string & プレイヤーの体力(20が最大) \\
        hunger & string & プレイヤーの満腹度(20が最大) \\
        pos & string & プレイヤーの現在の3次元座標 \\
        equip & list[string] & プレイヤーの装備中のアイテム(右手，左手，頭，体，脚，足) \\
        collected & list[string] & プレイヤーがこれまでに集めたアイテム \\
        chest & list[string] & 近くのチェスト \\
        \hline
    \end{tabular}
\end{table}

サバイバルモードのプレイヤー向けの対話機能の全体像や，プレイヤーの発話や情報の処理手順を図\ref{fig:interactive_function}に示す．
処理の手順としてまず，Chat Classificationモデルがプレイヤーの発話と情報を受け入れ，few-shot学習\cite{bib:few-shot}を使用してプレイヤーの発話を``Chat''，``Order''，``Request Next Task''の3つのカテゴリのいずれかに分類する．

発話が``Chat''に分類された場合，Chatモデルを用いて一般的な会話や質問に対応することができる．
このモデルはRetrieval-Augmented Generation (RAG)\cite{bib:rag}を用いており，通常は応答することが不可能な情報に対しても，大量のデータを参考にして応答を生成することが可能である．
RAGを用いる例として，Masonのテスト環境である，FUN Minecraft Server\cite{bib:fun_minecraft_server}に関する質問などが挙げられる．
これらの情報はインターネット上に情報が少ないことからもとのGPTモデルが学習しておらず回答が不安定であるが，RAGによってMasonはそれらの特定の条件に関する質問に答えることが出来る．

発話が``Order''に分類された場合，Actionモデルを用いてMasonが命令を解釈した後，表\ref{tab:action}の行動を実行し，プレイヤーの作業を手伝うことが可能である．
Orderに分類されるプレイヤーの発話の例としては，``cut the tree''などのMasonに対する命令文が考えられる．
命令文を受け取ると，Actionモデルでは，OpenAIのfunction calling\cite{bib:function_calling}によって適切な関数と引数が設定され，mine\_block("oak\_log",3)のように行動を実行することが可能である．

``Request Next Task''の分類では，プレイヤーの発話や情報がNext Taskモデルに，受け渡される．
Next TaskモデルのプロンプトはVoyager\cite{bib:voyager}のプロンプトに基づいており，プレイヤーの発話と情報から，Masonがプレイヤーに対して次のタスクを提示する．
また，提案されたタスクはActionモデルに渡され，Actionモデルが行動を実行できる場合は，プレイヤーのタスクを支援することができる．
例えば，プレイヤー情報のcollectedのリストが空である場合，モデルはプレイヤーがまだアイテムを集めたことがなく初期状態であると推論し，Minecraftにおける最初のタスク``cut the tree''などをプレイヤーに提案する．
そして提示した``cut the tree''というタスクはActionモデルにわたり，mine\_block("oak\_log",3)といった行動を起こすことが出来る．
したがって，Masonは初期状態のプレイヤーに対して``cut the tree''というタスクを提示し，同時にMasonも木を切って作業を手伝うことが出来る．

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{fig/interactive_function.PNG}
    \caption{サバイバルモード向け対話機能の全体像}
    \label{fig:interactive_function}
\end{figure}

\section{構造物自動生成}\label{sec:build_mode}
独自のプロンプトによって，クリエイティブモードのプレイヤー向けに構造物の自動生成が可能になった．
このプロンプトには，/fillコマンドで構造物を生成すること，/fillコマンドの説明，3次元座標の概念の説明，/fillコマンドの使用例を記述した．

このプロンプトを初期プロンプトとして，作りたい構造物のプロンプトを送ると，fillコマンドのリストが提示され，fillコマンドのリストをMineflayerを通して順番に実行すると構造物が生成される．
また，追加のプロンプトを使用して装飾を追加したり，修正を加えたりすることができる．

この機能によって自動生成できる構造物の一例を図\ref{fig:generate_example}に示す。生成できる構造物については\ref{sec:build_mode_generate}節でその他多くの例を示し、その結果の考察について\ref{sec:generate_investigation}で述べる.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{fig/generate_example.png}
    \caption{構造物自動生成の生成結果}
    \label{fig:generate_example}
\end{figure}



\section{構造物自動生成のファインチューニング}
人間の作成した構造物を学習させる事によりより複雑な構造が生成できることが考えられたため、構造物自動生成のファインチューニングを行った。
ファインチューニング済みモデルを作成するまでの手順は学習データの作成とファインチューニングに分けて解説する。

\subsection{学習データの作成}
学習データを作成するための手順として、まず、大規模言語モデルに読み込ませたい建造物をクリエイティブモードで手作業で作成した。家、ビル、木、クリーパー (Minecraftの代表的なキャラクター) のオブジェ等図\ref{fig:train_structure}に示す計15種類の構造物を作成した。

\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\textwidth]{fig/train_data.PNG}
    \caption{学習データの構造物}
    \label{fig:train_structure}
\end{figure}

次にストラクチャーブロックを用いて、手作業で作成した構造物をファイルに保存した。
ストラクチャーブロックとは範囲指定を行い、範囲内の構造物をNBTファイルとして保存したり、NBTファイルから構造物を読み出してMinecraft世界に出力することが可能なブロックである。
ストラクチャーブロックは図\ref{fig:structure_block}のような外観を有しており、通常の手段では入手できないものである。ストラクチャーブロックを入手するためにはゲームモードをクリエイティブモードの状態でチートを許可し以下のコマンドを実行すると入手可能である。
\begin{center}
    \textit{/give [player\_name] minecraft:structure\_block}
\end{center}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{fig/structure_block.png}
    \caption{ストラクチャーブロック}
    \label{fig:structure_block}
\end{figure}

構造物をファイルに保存した後は、データはNBTファイルというMinecraft固有のファイル形式であるためファイルの解析を行った。
NBTファイルの解析には外部ツールのPrismarine-NBT\cite{bib:prismarine-nbt}を用いた。
解析によって各座標に配置されたブロックの種類に関するデータのリスト得られたため各構造物に対して以下のアルゴリズムを適応しfillコマンドのリストを作成した。

\begin{enumerate}
    \item 重複を許した、2つのブロックの組み合わせを全て列挙する。
    \item 全ての2ブロックの組み合わせに対して、2ブロックを対角点とする直方体の範囲を作成する。
    \item 直方体の範囲内のブロックが、空気ブロック以外の同じブロックで満たされているものの中で最大の体積の直方体を抽出する。
    \item 抽出した最大の体積の直方体のデータをもとにfillコマンドを1つ作成する。fillコマンドを作成できたら抽出した直方体の範囲内のブロックを全て空気ブロックに置き換える。
    \item 全てのブロックが空気ブロックとなるまで3～4を繰り返す。
\end{enumerate}

最後に完成したfillコマンドのリストに、手動でアノテーション作業を行いfillコマンドで作成している部分の説明を加えた。

このような手順を踏むことで、構造物自動生成の学習データを作成した。
また、作成した学習データを分割し、装飾などの細部を少し変更したデータを作ることにより、合計19件の学習データを構築した。
完成した学習データ1件を、図\ref{fig:train_structure}左上のクリーパーのオブジェを例に次ページに示す。
\newpage
\noindent
user:

\noindent
\fbox{
    please make Creeper.
}

\noindent
assistant:

\noindent\fbox{
    \parbox{\textwidth}{
    This is a list of fill commands to create the face of the iconic Minecraft character ""Creeper"". \\
    The creeper is a typical Minecraft mob and is green. Therefore, we will create it using a green concrete block. \\
    We will create it by executing the /fill command in the following steps. \\
    \\
    1. Create the left eye with a 2x2 green concrete block. \\
    /fill \textasciitilde2 \textasciitilde5 \textasciitilde0 \textasciitilde3 \textasciitilde6 \textasciitilde0 minecraft:green\_concrete \\
    \\
    2. Create the right eye in the same way.\\
    /fill \textasciitilde6 \textasciitilde5 \textasciitilde0 \textasciitilde7 \textasciitilde6 \textasciitilde0 minecraft:green\_concrete\\
    \\
    3. Create a mouth with green concrete blocks. The creeper's mouth has a distinctive shape.\\
    /fill \textasciitilde3 \textasciitilde2 \textasciitilde0 \textasciitilde6 \textasciitilde3 \textasciitilde0 minecraft:green\_concrete\\
    /fill \textasciitilde4 \textasciitilde4 \textasciitilde0 \textasciitilde5 \textasciitilde4 \textasciitilde0 minecraft:green\_concrete\\
    /fill \textasciitilde3 \textasciitilde1 \textasciitilde0 \textasciitilde3 \textasciitilde1 \textasciitilde0 minecraft:green\_concrete\\
    /fill \textasciitilde6 \textasciitilde1 \textasciitilde0 \textasciitilde6 \textasciitilde1 \textasciitilde0 minecraft:green\_concrete\\
    \\
    4. Finally, create the contours of the face.\\
    /fill \textasciitilde1 \textasciitilde0 \textasciitilde0 \textasciitilde2 \textasciitilde4 \textasciitilde0 minecraft:lime\_concrete\\
    /fill \textasciitilde7 \textasciitilde0 \textasciitilde0 \textasciitilde8 \textasciitilde4 \textasciitilde0 minecraft:lime\_concrete\\
    /fill \textasciitilde1 \textasciitilde7 \textasciitilde0 \textasciitilde8 \textasciitilde7 \textasciitilde0 minecraft:lime\_concrete\\
    /fill \textasciitilde3 \textasciitilde0 \textasciitilde0 \textasciitilde6 \textasciitilde0 \textasciitilde0 minecraft:lime\_concrete\\
    /fill \textasciitilde4 \textasciitilde5 \textasciitilde0 \textasciitilde5 \textasciitilde6 \textasciitilde0 minecraft:lime\_concrete\\
    /fill \textasciitilde4 \textasciitilde1 \textasciitilde0 \textasciitilde5 \textasciitilde1 \textasciitilde0 minecraft:lime\_concrete\\
    /fill \textasciitilde1 \textasciitilde5 \textasciitilde0 \textasciitilde1 \textasciitilde6 \textasciitilde0 minecraft:lime\_concrete\\
    /fill \textasciitilde8 \textasciitilde5 \textasciitilde0 \textasciitilde8 \textasciitilde6 \textasciitilde0 minecraft:lime\_concrete\\
    /fill \textasciitilde3 \textasciitilde4 \textasciitilde0 \textasciitilde3 \textasciitilde4 \textasciitilde0 minecraft:lime\_concrete\\
    /fill \textasciitilde6 \textasciitilde4 \textasciitilde0 \textasciitilde6 \textasciitilde4 \textasciitilde0 minecraft:lime\_concrete\\
    }
}
\newpage

\subsection{ファインチューニング}
OpenAIドキュメントのFine-tuningページ\cite{bib:fine-tuning}を参考に学習データからjsonlファイルを作成しファインチューニングを行った。
ファインチューニング時の設定は以下の通りである。

\begin{table}[H]
    \caption{ファインチューニングの設定}\label{tab:finetuning}
    \centering
    \begin{tabular}{ll}
        \hline \hline
        モデル & gpt-3.5-turbo-1106 \\
        \hline
        学習データ & training\_data.jsonl \\
        \hline
        学習データ件数 & 19件 \\
        \hline
        エポック & 5 \\
        \hline
    \end{tabular}
\end{table}